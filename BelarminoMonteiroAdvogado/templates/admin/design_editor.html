{% extends "admin/admin_base.html" %}

{% block title %}Editor de Design Visual{% endblock %}

{% block extra_css %}
<style>
    .editor-wrapper {
        display: flex;
        height: calc(100vh - 56px); /* Altura total menos o header */
        overflow: hidden;
    }
    .editor-sidebar {
        width: 380px; /* Aumentado para caber melhor */
        padding: 20px;
        background-color: #f8f9fa;
        overflow-y: auto;
        border-right: 1px solid #dee2e6;
        flex-shrink: 0;
    }
    .preview-wrapper {
        flex-grow: 1;
        position: relative;
        background-color: #e9ecef;
        padding: 20px;
    }
    .preview-iframe {
        width: 100%;
        height: 100%;
        border: 1px solid #ccc;
        background-color: #fff;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
        border-radius: 8px;
    }
    .preview-loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
    }
    /* Estilos do Color Picker */
    .color-group {
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #eee;
        margin-bottom: 15px;
    }
    .color-group-title {
        font-size: 0.85rem;
        font-weight: 700;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 10px;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
    }
    .input-group-text.color-picker-value {
        width: 100px;
        font-family: monospace;
        font-size: 0.85em;
    }
    .color-swatch-preview {
        display: inline-block;
        width: 20px; height: 20px;
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 3px;
        margin-right: 5px;
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block content %}
<div class="editor-wrapper">
    <aside class="editor-sidebar">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Design System</h4>
            <span class="badge bg-primary">V2.0</span>
        </div>
        <p class="text-muted small">Personalize as cores dos temas. As alterações são aplicadas ao salvar.</p>
        
        <form id="design-form" method="POST">
            {{ form.hidden_tag() }}

            {# --- SEÇÃO 1: NOVOS TEMAS (V2.0) --- #}
            <div class="color-group">
                <div class="color-group-title text-success">Novos Temas (V2.0)</div>
                
                {% set new_themes_data = [
                    ('color_opt5_primary', 'Invisible Luxury (Opt 5)', 'cor_primaria_tema5', settings.cor_primaria_tema5 or '#9b1b20', 'Cor de destaque (Vermelho)'),
                    ('color_opt6_primary', 'Titan Executive (Opt 6)', 'cor_primaria_tema6', settings.cor_primaria_tema6 or '#002F49', 'Cor primária (Navy)'),
                    ('color_opt7_primary', 'Golden Boutique (Opt 7)', 'cor_primaria_tema7', settings.cor_primaria_tema7 or '#D4AF37', 'Cor Dourada Principal'),
                    ('color_opt8_primary', 'Future Tech (Opt 8)', 'cor_primaria_tema8', settings.cor_primaria_tema8 or '#FF4D4D', 'Cor Neon (Glow)')
                ] %}

                {% for field_name, label, setting_key, default_val, help in new_themes_data %}
                    <div class="mb-3">
                        <label for="{{ field_name }}_picker" class="form-label small fw-bold">{{ label }}</label>
                        <div class="input-group input-group-sm">
                            {{ form[field_name](
                                class="form-control form-control-color color-picker-input", 
                                id=field_name ~ "_picker",
                                value=default_val,
                                **{'data-css-var': '--' ~ setting_key|replace('_', '-')}
                            ) }}
                            <span class="input-group-text color-picker-value">
                                <span class="color-swatch-preview" style="background-color: {{ default_val }}"></span>
                                <span>{{ default_val }}</span>
                            </span>
                        </div>
                        <small class="text-muted" style="font-size: 0.75rem;">{{ help }}</small>
                    </div>
                {% endfor %}
            </div>

            {# --- SEÇÃO 2: TEMAS CLÁSSICOS (V1.0) --- #}
            <div class="color-group">
                <div class="color-group-title text-secondary">Temas Clássicos (V1.0)</div>
                
                {% set classic_themes_data = [
                    ('color_opt1_primary', 'Luxo V1 (Opt 1)', 'cor_primaria_tema1', settings.cor_primaria_tema1 or '#9B1B20', 'Vermelho Clássico'),
                    ('color_opt2_primary', 'Titan V1 (Opt 2)', 'cor_primaria_tema2', settings.cor_primaria_tema2 or '#002F49', 'Navy Corporativo'),
                    ('color_opt2_secondary', 'Titan Sec. (Opt 2)', 'cor_secundaria_tema2', settings.cor_secundaria_tema2 or '#8A1218', 'Vermelho Secundário'),
                    ('color_opt3_primary', 'Boutique V1 (Opt 3)', 'cor_primaria_tema3', settings.cor_primaria_tema3 or '#B78C1A', 'Dourado Premium'),
                    ('color_opt4_primary', 'Tech V1 (Opt 4)', 'cor_primaria_tema4', settings.cor_primaria_tema4 or '#FF4D4D', 'Vermelho Neon')
                ] %}

                {% for field_name, label, setting_key, default_val, help in classic_themes_data %}
                    <div class="mb-3">
                        <label for="{{ field_name }}_picker" class="form-label small fw-bold">{{ label }}</label>
                        <div class="input-group input-group-sm">
                            {{ form[field_name](
                                class="form-control form-control-color color-picker-input", 
                                id=field_name ~ "_picker",
                                value=default_val,
                                **{'data-css-var': '--' ~ setting_key|replace('_', '-')}
                            ) }}
                            <span class="input-group-text color-picker-value">
                                <span class="color-swatch-preview" style="background-color: {{ default_val }}"></span>
                                <span>{{ default_val }}</span>
                            </span>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="d-grid gap-2 sticky-bottom bg-light p-2 border-top">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-2"></i>Salvar Todas as Alterações
                </button>
            </div>
        </form>
    </aside>

    <main class="preview-wrapper">
        <div id="loader" class="preview-loader">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando Preview...</span>
            </div>
        </div>
        {# Passa param 'preview=true' para desabilitar memoria temporarias ou scripts pesados se necessário #}
        <iframe id="preview-frame" class="preview-iframe" src="{{ url_for('main.home', preview='true') }}"></iframe>
        
        <div class="position-absolute bottom-0 end-0 m-4 bg-white p-2 rounded shadow small opacity-75">
            Preview em Tempo Real (Salve para persistir)
        </div>
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const iframe = document.getElementById('preview-frame');
    const loader = document.getElementById('loader');

    // Esconde loader
    iframe.addEventListener('load', function() {
        loader.style.display = 'none';
    });

    // Envia mensagens para o iframe (Live Preview)
    function updatePreview(key, value) {
        // Nota: Para o live preview funcionar perfeitamente, o script.js ou preview.js
        // no front-end deve estar escutando mensagens 'postMessage'.
        // Este código envia a mensagem.
        if(iframe.contentWindow) {
            iframe.contentWindow.postMessage({ 
                type: 'updateStyle', 
                payload: { [key]: value } 
            }, '*');
        }
    }

    // Lógica dos Pickers
    document.querySelectorAll('.color-picker-input').forEach(picker => {
        const parentGroup = picker.closest('.input-group');
        const swatch = parentGroup.querySelector('.color-swatch-preview');
        const textSpan = parentGroup.querySelector('span:last-child');

        picker.addEventListener('input', function() {
            const newVal = this.value;
            const cssVar = this.dataset.cssVar;

            // Atualiza UI local
            swatch.style.backgroundColor = newVal;
            textSpan.textContent = newVal.toUpperCase();

            // Envia para o iframe
            updatePreview(cssVar, newVal);
        });
    });
});
</script>
{% endblock %}