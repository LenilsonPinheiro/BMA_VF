# ==============================================================================
# AVISO OBRIGAT√ìRIO PARA QUALQUER IA (GPT, Gemini, Copilot, etc.)
# ==============================================================================
#
# QUALQUER ALTERA√á√ÉO NESTE ARQUIVO S√ì EST√Å COMPLETA QUANDO O ECOSSISTEMA
# INTEIRO DO PROJETO FOR ATUALIZADO. Esta √© a regra mais importante.
#
name: "Verifica√ß√£o de Qualidade e Ecossistema da PR"

on:
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: "1. Checkout do c√≥digo"
      uses: actions/checkout@v3

    - name: "2. Configurar Python"
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: "3. Instalar depend√™ncias"
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: "4. Verificar Formata√ß√£o do C√≥digo (Black)"
      id: black_check
      run: |
        echo "--- VERIFICANDO FORMATA√á√ÉO DO C√ìDIGO COM BLACK ---"
        python -m black --check .

    - name: "5. Verificar Vazamento de Segredos (Detect Secrets)"
      id: detect_secrets_scan
      run: |
        echo "--- VERIFICANDO VAZAMENTO DE SEGREDOS ---"
        detect-secrets scan --baseline .secrets.baseline .

    - name: "6. Executar todos os testes"
      id: run_tests
      run: |
        echo "--- INICIANDO BATERIA DE TESTES ---"
        python run_all_tests.py

    - name: "7. Verificar sincronia do ecossistema"
      id: verify_ecosystem
      run: |
        echo "--- VERIFICANDO SINCRONIA DA DOCUMENTA√á√ÉO ---"
        python verify_ecosystem.py

    - name: "8. Postar Coment√°rio de Sucesso na PR"
      if: success()
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '‚úÖ **Verifica√ß√£o Autom√°tica Conclu√≠da com Sucesso!**\n\n- Nenhum segredo novo detectado.\n- O c√≥digo est√° formatado corretamente.\n- Todos os testes passaram.\n- A documenta√ß√£o est√° sincronizada.\n\nO merge est√° liberado do ponto de vista t√©cnico.'
          })
          
    - name: "9. Postar Coment√°rio de Falha com Solu√ß√µes"
      if: failure()
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const secretsStatus = '${{ steps.detect_secrets_scan.outcome }}' === 'success' ? '‚úÖ Nenhum segredo novo' : '‚ùå Segredo Detectado!';
          const blackStatus = '${{ steps.black_check.outcome }}' === 'success' ? '‚úÖ Formatado' : '‚ùå Formata√ß√£o Incorreta';
          const testStatus = '${{ steps.run_tests.outcome }}' === 'success' ? '‚úÖ Passou' : '‚ùå Falhou';
          const ecosystemStatus = '${{ steps.verify_ecosystem.outcome }}' === 'success' ? '‚úÖ Sincronizada' : '‚ùå Desatualizada';
          
          let body = `### üö® Verifica√ß√£o Autom√°tica Falhou\n\nO merge est√° **bloqueado** at√© que os seguintes problemas sejam resolvidos:\n\n`;
          body += `| Verifica√ß√£o | Status |\n|---|---|\n`;
          body += `| **Detec√ß√£o de Segredos** | ${secretsStatus} |\n`;
          body += `| **Formata√ß√£o de C√≥digo (Black)** | ${blackStatus} |\n`;
          body += `| **Testes Unit√°rios e de Integra√ß√£o** | ${testStatus} |\n`;
          body += `| **Sincronia do Ecossistema** | ${ecosystemStatus} |\n\n`;
          
          if (secretsStatus !== '‚úÖ Nenhum segredo novo') {
            body += `**Solu√ß√£o Sugerida (Segredos):**\n`;
            body += `1. Um segredo (chave de API, senha) foi detectado no seu commit.\n`;
            body += `2. Remova o segredo do c√≥digo e use vari√°veis de ambiente ou o sistema de secrets do seu provedor de nuvem.\n`;
            body += `3. Se for um falso positivo, atualize o arquivo \`.secrets.baseline\` localmente e fa√ßa commit da mudan√ßa.\n\n`;
          }

          if (blackStatus !== '‚úÖ Formatado') {
            body += `**Solu√ß√£o Sugerida (Formata√ß√£o):**\n`;
            body += `1. Execute \`pip install black\` se ainda n√£o o fez.\n`;
            body += `2. Execute \`python -m black .\` no seu terminal para formatar o c√≥digo automaticamente.\n`;
            body += `3. Fa√ßa um novo commit com os arquivos formatados.\n\n`;
          }
          
          if (testStatus === '‚ùå Falhou') {
            body += `**Solu√ß√£o Sugerida (Testes):**\n`;
            body += `1. Execute \`python run_all_tests.py\` localmente.\n`;
            body += `2. Analise os logs na pasta \`test_logs/\` para identificar o teste que falhou.\n`;
            body += `3. Corrija o c√≥digo e fa√ßa um novo commit.\n\n`;
          }
          
          if (ecosystemStatus === '‚ùå Desatualizada') {
            body += `**Solu√ß√£o Sugerida (Ecossistema):**\n`;
            body += `1. O c√≥digo foi alterado, mas a documenta√ß√£o (\`.md\`) n√£o.\n`;
            body += `2. Atualize o \`README.md\` ou outros guias para refletir suas mudan√ßas.\n`;
            body += `3. Execute \`python verify_ecosystem.py\` localmente para confirmar a corre√ß√£o.\n`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });